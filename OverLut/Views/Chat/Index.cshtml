@{
    ViewData["Title"] = "Test Chat WebSocket";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <h4>Cấu hình kết nối</h4>
            <div class="form-group mb-3">
                <label>User ID (GUID):</label>
                <input type="text" id="userId" class="form-control" value="00000000-0000-0000-0000-000000000001" />
            </div>
            <div class="form-group mb-3">
                <label>Channel ID (GUID):</label>
                <input type="text" id="channelId" class="form-control" value="00000000-0000-0000-0000-000000000001" />
            </div>
            <button id="btnConnect" class="btn btn-success w-100" onclick="connect()">Kết nối WebSocket</button>
            <hr />
            <div id="status" class="badge bg-secondary">Chưa kết nối</div>
        </div>

        <div class="col-md-8">
            <h4>Khung Chat</h4>
            <div id="chatBox" style="height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 15px; background: #f9f9f9;" class="mb-3">
                <ul id="messagesList" class="list-unstyled"></ul>
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn..." disabled />
                <button id="btnSend" class="btn btn-primary" onclick="sendMessage()" disabled>Gửi</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let socket;

        function connect() {
            const userId = document.getElementById("userId").value;
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const wsUri = `${protocol}://${window.location.host}/ws?userId=${userId}`;

            socket = new WebSocket(wsUri);

            socket.onopen = function (e) {
                document.getElementById("status").innerText = "Đã kết nối";
                document.getElementById("status").className = "badge bg-success";
                document.getElementById("messageInput").disabled = false;
                document.getElementById("btnSend").disabled = false;
                document.getElementById("btnConnect").disabled = true;
                console.log("WebSocket connected.");
            };

            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                appendMessage(data.UserId, data.Content, data.CreateAt);
            };

            socket.onclose = function (e) {
                document.getElementById("status").innerText = "Đã ngắt kết nối";
                document.getElementById("status").className = "badge bg-danger";
            };

            socket.onerror = function (e) {
                console.error("WebSocket Error: ", e);
            };
        }

        function sendMessage() {
            const channelId = document.getElementById("channelId").value;
            const content = document.getElementById("messageInput").value;

            if (!content) return;

            // Khớp với cấu trúc MessageDTO của bạn
            const msgDto = {
                ChannelId: channelId,
                Content: content,
                MessageType: 0 // Text
            };

            socket.send(JSON.stringify(msgDto));
            document.getElementById("messageInput").value = "";
        }

        function appendMessage(user, content, time) {
            const list = document.getElementById("messagesList");
            const li = document.createElement("li");
            const date = new Date(time).toLocaleTimeString();

            li.innerHTML = `<small class="text-muted">[${date}]</small> <strong>${user.substring(0,8)}...:</strong> ${content}`;
            li.className = "border-bottom mb-2 pb-1";
            list.appendChild(li);

            
            const chatBox = document.getElementById("chatBox");
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        
        document.getElementById("messageInput").addEventListener("keypress", function(e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
}